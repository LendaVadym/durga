# Database Installation and Migration with Flyway

This directory contains the database schema management files for the Durga application using Flyway.

## Overview

The project has been migrated from Entity Framework Code-First approach to using Flyway for database schema management while keeping Entity Framework Core as the ORM.

## Directory Structure

```
db_install/
├── flyway.conf          # Flyway configuration file
├── sql/                 # SQL migration scripts directory
│   └── V1__Initial_Schema.sql  # Initial database schema
└── README.md           # This file
```

## Prerequisites

1. **PostgreSQL Database** - Ensure you have a PostgreSQL server running
2. **Flyway CLI** - Download and install Flyway from https://flywaydb.org/download/

## Configuration

Update the `flyway.conf` file with your database connection details:

```properties
flyway.url=jdbc:postgresql://localhost:5432/your_database_name
flyway.user=your_username
flyway.password=your_password
```

### Environment Variables (Recommended for Production)

Instead of hardcoding credentials in the config file, use environment variables:

```bash
export FLYWAY_URL="jdbc:postgresql://localhost:5432/durga_db"
export FLYWAY_USER="your_username" 
export FLYWAY_PASSWORD="your_password"
```

## Usage

### Initial Database Setup

1. **Create the database** (if it doesn't exist):
   ```sql
   CREATE DATABASE durga_db;
   ```

2. **Run Flyway migration**:
   ```bash
   cd db_install
   flyway migrate
   ```

### Common Flyway Commands

- **Check migration status**:
  ```bash
  flyway info
  ```

- **Validate migrations**:
  ```bash
  flyway validate
  ```

- **Clean database** (⚠️ WARNING: This will drop all objects):
  ```bash
  flyway clean
  ```

- **Baseline existing database**:
  ```bash
  flyway baseline
  ```

### Adding New Migrations

1. Create a new SQL file in the `sql/` directory following the naming convention:
   ```
   V<version>__<description>.sql
   ```
   
   Example: `V2__Add_user_preferences.sql`

2. Write your SQL DDL/DML statements in the file

3. Run the migration:
   ```bash
   flyway migrate
   ```

## Migration Files

### V1__Initial_Schema.sql

This is the initial migration that creates all the necessary tables for the Durga application:

- **ASP.NET Identity Tables**: AspNetUsers, AspNetRoles, etc.
- **Custom Domain Tables**: users, roles, user_roles, departments, teams, team_users
- **Indexes**: All necessary indexes for optimal performance
- **Foreign Key Constraints**: Proper relationships between tables

## Entity Framework Core Integration

The application still uses Entity Framework Core as the ORM, but without Code-First features:

- **DbContext configurations** are simplified to only handle column mappings and relationships
- **No migrations** are generated by EF Core
- **Database schema** is managed entirely by Flyway

## Best Practices

1. **Never modify existing migration files** once they've been applied
2. **Always create new migration files** for schema changes
3. **Test migrations** on a copy of production data before applying to production
4. **Backup your database** before running migrations in production
5. **Use transactions** in your migration scripts when possible
6. **Keep migrations small and focused** on specific changes

## Troubleshooting

### Common Issues

1. **Connection refused**: Check that PostgreSQL is running and connection details are correct
2. **Permission denied**: Ensure the database user has sufficient privileges
3. **Migration checksum mismatch**: This happens when a migration file is modified after being applied

### Support

For more information about Flyway, visit the official documentation:
https://flywaydb.org/documentation/

## Schema Overview

The database contains two main contexts:

1. **Identity Context**: Handles ASP.NET Identity tables for authentication
2. **Domain Context**: Handles custom business entities (Users, Roles, Departments, Teams)

All tables are created in the `public` schema in PostgreSQL.